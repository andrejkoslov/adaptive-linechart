class LineChart{constructor(t,e,i,a,s){null==t&&(t=document.getElementsByTagName("BODY")[0]),null==e&&(e=getRandomInt()),null==s&&(s="linechart"),null==i&&(i=t.clientWidth),this.chartDiv=addNewElement(t,"div",{class:s,id:"chart_"+e,chart_id:e,style:"float:left; width:"+i+"px; padding-bottom:8px;"}),null!=a?(this.title=addNewElement(this.chartDiv,"label",{class:"chart-title nowrap",style:"width:"+(i-20)+"px; text-align:center; display:block; margin-left:10px; margin-top:10px"}),this.title.innerHTML=a):this.title=null;var n=i-30,h=300;isMobil?h=220:i<200?h=200:i<300?h=220:i<400?h=240:i<500?h=260:i<600&&(h=280),this.canvas=addNewElement(this.chartDiv,"canvas",{id:"chart_"+e+"_canvas",width:n,height:h,style:"margin: 15px 17px 3px 13px;"}),this.canvas.dataset.chartId=e.toString(),this.context=this.canvas.getContext("2d"),this.context.translate(.5,.5),isMobil||(this.canvas.addEventListener("mouseout",(function(t){var e=document.getElementById("chart_"+this.dataset.chartId+"_livedata");null!=e&&(e.innerText="-")})),this.canvas.addEventListener("mousemove",(function(t){var e=document.getElementById("chart_"+this.dataset.chartId+"_livedata");if(null!=e)if(this.height-t.offsetY<this.dataset.paddingBottom||t.offsetX<this.dataset.paddingLeft)e.innerText="-";else{var i=this.dataset.maxVal-t.offsetY/parseFloat(this.dataset.coefVal);if(isNaN(i))e.innerText="-";else{i=i<100?i.toFixed(2):i<200?i.toFixed(1):Math.round(i);var a=parseInt(this.dataset.minTs)+Math.round((t.offsetX-parseInt(this.dataset.paddingLeft))/parseFloat(this.dataset.coefTs));isNaN(a)?e.innerText="-":(a=new Date(1e3*a).separate(),e.innerHTML="Date <b>"+a.mday+"."+a.month+"."+a.year+"</b> Time <b>"+a.hour+":"+a.min+"</b> Value <b>"+i+"</b>")}}})),addNewElement(this.chartDiv,"div",{class:"chart-live-data",id:"chart_"+e+"_livedata",style:"margin-left: 12px; margin-right: 12px; margin-bottom: 4px; max-width:95%;",innerText:"-"})),this.legendDiv=addNewElement(this.chartDiv,"div",{class:"chart-legend",id:"chart_"+e+"_legend"}),this.chartId=e,this.lines=[],this.minTs=99999999999999,this.maxTs=0,this.minVal=999999999999999,this.maxVal=0,this.axeYLabelStep=null,this.axeYLabelHeight=30,this.axeXLabelWidth=80,this.coefTs=null,this.coefVal=null,this.padding={left:50,bottom:35},this.endDate=null,this.avgStep=NaN}addLine(t){if(null==t.values)return logger.error("Function LineChart.newLine(). DataString is null."),!1;if(!isString(t.values))return logger.error("Function LineChart.newLine(). DataString is not a string."),!1;var e=this._createLine(t);if(null==e)return logger.error("Function LineChart.newLine(). Function _createLine() return null."),!1;e.objName=t.obj_name,e.parName=t.par_name,e.parId=t.par_id;var i=this.colors[this.lines.length];return isMobil,e.legend=addNewElement(this.legendDiv,"div",{class:"chart-legend-item nowrap",id:"chart_"+this.chartId+"_legend_"+t.par_id,style:"max-width:"+(this.chartDiv.clientWidth-20)+"px;",onclick:"processSelectLegendItem("+this.chartId+","+this.lines.length+","+e.parId+")",innerHTML:'<span class="chart-legend-color" style="background-color:'+i+"; color:"+i+';">--</span>'+e.objName+" / "+e.parName}),this.lines.push(e),!0}updateLines(t){if(null==t)return logger.error("Function LineChart.updateLines(). Parameter lines is null."),!1;if(!Array.isArray(t))return logger.error("Function LineChart.updateLines(). Parameter lines is not a array."),!1;for(var e in this.lines=[],this.minTs=99999999999999,this.maxTs=0,this.minVal=999999999999999,this.maxVal=0,this.axeYLabelStep=null,this.coefTs=null,this.coefVal=null,t){var i=this._createLine(t[e]);null!=i&&this.lines.push(i)}return this.draw(),!0}_createLine(t){var e=new SingleLine(t),i=!0;if(0==t.values.length)return e;for(var a=t.values.split(";"),s=a.length,n=0;n<s;++n){var h=a[n].split("/");if(""!=h[0])if(isNaN(h[0]))logger.warn("LineChart._createLine(). Item "+n+' contains invalid time-stamp "'+h[0]+'".');else{var l={ts:null,val:null};if(l.ts=parseInt(h[0]),l.val=parseFloat(h[1]),l.val<0)return logger.error("LineChart._createLine(). Negative values not supported! ts="+l.ts+" val="+l.val),null;e.real.push(l),isNaN(l.val)||(l.val<this.minVal&&(this.minVal=Math.floor(.95*l.val)),l.val>this.maxVal&&(this.maxVal=Math.ceil(1.05*l.val)),i=!1),l.ts<this.minTs&&(this.minTs=l.ts),l.ts>this.maxTs&&(this.maxTs=l.ts)}else logger.warn("LineChart._createLine(). Item "+n+" time-stamp is empty.")}if(0==e.real.length)return e;e.isEmpty=!1,(0==this.maxVal&&0==this.minVal||i)&&(this.minVal=0,this.maxVal=1);var r=this.context.measureText(this.minVal.toString()),o=this.context.measureText(this.maxVal.toString());return r.width<o.width?this.padding.left=Math.round(o.width)+23:this.padding.left=Math.round(r.width)+23,e}clear(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}draw(){if(this.coefTs=(this.canvas.width-this.padding.left)/(this.maxTs-this.minTs),this.coefVal=(this.canvas.height-this.padding.bottom)/(this.maxVal-this.minVal),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),!this.isEmpty()){this._drawAxeX(),this._drawAxeY();for(var t=0;t<this.lines.length;t++)this.drawLine(t);this.canvas.dataset.minTs=this.minTs.toString(),this.canvas.dataset.coefTs=this.coefTs.toString(),this.canvas.dataset.maxVal=this.maxVal.toString(),this.canvas.dataset.coefVal=this.coefVal.toString(),this.canvas.dataset.paddingLeft=this.padding.left.toString(),this.canvas.dataset.paddingBottom=this.padding.bottom.toString()}}resize(t,e){this.canvas.width=this.canvas.width+t,this.canvas.height=this.canvas.height+e,this.context.translate(.5,.5)}_drawAxeX(){this.context.strokeStyle=this.colorDefault,this.context.lineWidth=1,this.context.beginPath(),this.context.moveTo(this.padding.left,this.canvas.height-this.padding.bottom),this.context.lineTo(this.canvas.width,this.canvas.height-this.padding.bottom),this.context.stroke();var t,e=Math.round(this.axeXLabelWidth/this.coefTs/60);t=this.stepsX.length-1;for(var i=0;i<t;i++)if(e>this.stepsX[i]&&e<this.stepsX[i+1]){e=this.stepsX[i];break}e*=60;for(var a=this._getBeginOfDayFromUnixTs(this.minTs),s=(new Date).getTime()/1e3;a<s;){if(a>this.minTs){!0;break}a+=e}for(var n,h,l=[];a<this.maxTs;)n=this._convertTs2PosX(a),h=this._formatTsForLabel(a,this.maxTs-this.minTs),l.push({X:n,str:h}),a+=e;this.context.beginPath(),this.context.strokeStyle="#e6e6e6";var r=Math.round(e*this.coefTs/2),o=this.canvas.height-this.padding.bottom;t=l.length;for(i=0;i<t;i++)this.context.moveTo(l[i].X,0),this.context.lineTo(l[i].X,o),l[i].X-r>this.padding.left+2&&(this.context.moveTo(l[i].X-r,0),this.context.lineTo(l[i].X-r,o));for(null!=l[i-1]&&l[i-1].X+r<=this.canvas.width&&(this.context.moveTo(l[i-1].X+r,0),this.context.lineTo(l[i-1].X+r,o)),this.context.stroke(),this.context.font="12px arial",t=l.length,i=0;i<t;i++)this.context.fillText(l[i].str.hm,l[i].X-17,o+17),(0==i||l[i].str.dm!=l[i-1].str.dm)&&this.context.fillText(l[i].str.dm,l[i].X-17,o+32);this.context.closePath()}_drawAxeY(){if(null!=this.coefTs&&null!=this.coefVal){var t,e=(this.canvas.height-this.padding.bottom)/this.axeYLabelHeight;this.axeYLabelStep=(this.maxVal-this.minVal)/e;for(var i,a,s=1,n=!1;s<1e11;){for(var h=0;h<this.stepsY.length-1;h++)if(i=this.stepsY[h]*s,a=this.stepsY[h+1]*s,i<=this.axeYLabelStep&&this.axeYLabelStep<=a){this.axeYLabelStep=a,n=!0;break}if(n)break;s*=10}var l=0;if(this.minVal<0)for(;l>this.minVal&&!(l<=this.minVal);)l-=this.axeYLabelStep;else if(this.minVal>0)for(;l<this.maxVal&&!(l>=this.minVal);)l+=this.axeYLabelStep;var r,o,d,c=[];for(h=0;h<33&&(o=l+this.axeYLabelStep*h,(this.axeYLabelStep<1||2.5==this.axeYLabelStep)&&(o=o.toFixed(2)),!((r=this._convertVal2PosY(o))<0));){var g={value:o,Y:r};c.push(g),h++}for(this.context.lineWidth=1,this.context.beginPath(),this.context.strokeStyle=this.colorDefault,this.context.moveTo(this.padding.left,0),this.context.lineTo(this.padding.left,this.canvas.height-this.padding.bottom),this.context.stroke(),this.context.beginPath(),this.context.strokeStyle="#e6e6e6",t=c.length,h=0;h<t;h++)(d=c[h].Y+Math.round(this.coefVal*this.axeYLabelStep/2))<this.canvas.height-this.padding.bottom&&(this.context.moveTo(this.padding.left,d),this.context.lineTo(this.canvas.width,d)),c[h].Y>=this.canvas.height-this.padding.bottom||(this.context.moveTo(this.padding.left,c[h].Y),this.context.lineTo(this.canvas.width,c[h].Y));for((d=c[c.length-1].Y-Math.round(this.coefVal*this.axeYLabelStep/2))>0&&(this.context.moveTo(this.padding.left,d),this.context.lineTo(this.canvas.width,d)),this.context.stroke(),this.context.font="12px arial",this.context.strokeStyle=this.colorDefault,t=c.length,h=0;h<t;h++)this.context.fillText(c[h].value,0,c[h].Y+10)}}drawLine(t){var e=this.lines[t];if(null!=e){if(1!=e.isEmpty&&0!=e.real.length&&!e.hidden){var i,a=[],s=-1,n=[],h=[];if(!isNaN(this.avgStep)){for(var l=this._getBeginOfDayFromUnixTs(e.real[0].ts);l<e.real[0].ts;)l+=this.avgStep;i=e.real.length;for(var r=0;r<i;r++)if(e.real[r].ts<l)n.push(e.real[r].val);else{for(var o=0;e.real[r].ts>l+this.avgStep;)if(l+=this.avgStep,++o>1e3)return void logger.warn("drawLine(). Can't calculate average values for this line. "+new Date(1e3*e.real[r].ts).formatISOLocal()+"/"+e.real[r].val);var d={ts:l,val:getAvgValue(n,2)};h.push(d),(n=[]).push(e.real[r].val),l+=this.avgStep}if(n.length>0){d={ts:l,val:getAvgValue(n,2)};h.push(d)}}n=[],0==h.length&&(h=e.real),i=h.length;for(var c=0;c<i;c++){(d={X:NaN,Y:NaN}).X=this._convertTs2PosX(h[c].ts),isNaN(h[c].val)||(d.Y=this._convertVal2PosY(h[c].val)),d.X!=s?(s=d.X,n.length>0&&c>0&&(n.push(a[a.length-1].Y),a[a.length-1].Y=getAvgValue(n,2),n=[]),a.push(d)):n.push(d.Y)}for(this.context.strokeStyle=this.colors[t],this.context.lineWidth=1,this.context.beginPath(),i=a.length,c=0;c<i;c++)if(!isNaN(a[c].Y)){this.context.moveTo(a[c].X,a[c].Y),c++;break}for(;c<i;)if(isNaN(a[c].Y))for(this.context.stroke(),c++;c<a.length;){if(!isNaN(a[c].Y)){c++;break}c++}else this.context.lineTo(a[c].X,a[c].Y),c++;this.context.stroke()}}else logger.error("Function LineChart.drawLine(lineId). The line with ID "+t+" not found!")}isEmpty(){for(var t=!0,e=0;e<this.lines.length;e++)this.lines[e].isEmpty||(t=!1);return t}_convertTs2PosX(t){return this.canvas.width-Math.round((this.maxTs-t)*this.coefTs)}_convertVal2PosY(t){return Math.round((this.maxVal-t)*this.coefVal)}_formatTsForLabel(t,e){let i=new Date(1e3*t);e/=86400;let a=i.getFullYear(),s=i.getMonth()+1;s<10&&(s="0"+s.toString());let n=i.getDate();parseInt(n)<10&&(n="0"+n.toString());let h=i.getHours();parseInt(h)<10&&(h="0"+h);let l=i.getMinutes();parseInt(l)<10&&(l="0"+l.toString());let r={};return r=e<3?{dm:n+"."+s,hm:h+":"+l}:e>=3&&e<180?{dm:a,hm:n+"."+s}:{dm:a,hm:" "+s},r}_getBeginOfDayFromUnixTs(t){var e=new Date(1e3*t);return(e=new Date(e.getFullYear(),e.getMonth(),e.getDate())).setMinutes(59),e.setSeconds(59),e.setMilliseconds(1e3),e.getTime()/1e3}colors=["#0044CC","#008000","#FF8533","#6A6A6A","#C71585","#8B4513","#1E90FF","#FF4500","#00FF00","#8A2BE2"];colorDefault="#657585";stepsX=[2,5,10,15,20,30,60,90,120,240,300,360,720,1440,2880,4320,5760,7200,10080,14400,21600,28800,43200,64800,86400,129600,172800];stepsY=[.01,.02,.05,.1]}class SingleLine{constructor(t){this.parId=t.par_id,this.parName=t.par_name,this.objName=t.obj_name,this.real=[],this.isEmpty=!0,this.hidden=!1}}
